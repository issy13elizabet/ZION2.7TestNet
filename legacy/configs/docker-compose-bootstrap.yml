# ZION Bootstrap Production Stack
# Spuštění reálného ZION blockchainu s bootstrap patch pro genesis mining

version: '3.8'

services:
  # SEED1 - Hlavní ZION CryptoNote daemon
  seed1:
    image: zion:bootstrap-fixed
    container_name: zion-seed1-bootstrap
    command: >
      ziond
      --config-file=/config/zion.conf
      --data-dir=/data
      --rpc-bind-ip=0.0.0.0
      --rpc-bind-port=18081
      --p2p-bind-ip=0.0.0.0
      --p2p-bind-port=28080
      --add-priority-node=seed2:28080
      --log-level=2
    ports:
      - "18081:18081"  # RPC port
      - "28080:28080"  # P2P port
    volumes:
      - zion-seed1-data:/data
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18081/getinfo"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    networks:
      - zion-net
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # SEED2 - Backup ZION daemon 
  seed2:
    image: zion:bootstrap-fixed
    container_name: zion-seed2-bootstrap
    command: >
      ziond
      --config-file=/config/zion.conf
      --data-dir=/data
      --rpc-bind-ip=0.0.0.0
      --rpc-bind-port=18081
      --p2p-bind-ip=0.0.0.0
      --p2p-bind-port=28080
      --add-priority-node=seed1:28080
      --log-level=2
    ports:
      - "18082:18081"  # RPC port (mapped differently)
      - "28081:28080"  # P2P port (mapped differently)
    volumes:
      - zion-seed2-data:/data
      - ./config:/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18081/getinfo"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    networks:
      - zion-net
    depends_on:
      seed1:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # RPC SHIM - Bridge mezi ZION daemon a mining pool
  rpc-shim:
    build:
      context: ./adapters/zion-rpc-shim
      dockerfile: Dockerfile
    container_name: zion-rpc-shim-bootstrap
    environment:
      - ZION_DAEMON_HOST=seed1
      - ZION_DAEMON_PORT=18081
      - RPC_SHIM_PORT=18089
      - LOG_LEVEL=info
      - ENABLE_GETBLOCKTEMPLATE_CACHE=true
      - CACHE_TTL=10
    ports:
      - "18089:18089"
    volumes:
      - ./logs:/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18089/json_rpc", "-d", '{"jsonrpc":"2.0","id":1,"method":"get_height","params":{}}', "-H", "Content-Type: application/json"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - zion-net
    depends_on:
      seed1:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # MINING POOL - Stratum server pro minery
  mining-pool:
    build:
      context: ./pool
      dockerfile: Dockerfile
    container_name: zion-mining-pool-bootstrap
    environment:
      - POOL_HOST=0.0.0.0
      - POOL_PORT=3333
      - RPC_HOST=rpc-shim
      - RPC_PORT=18089
      - POOL_FEE=1.0
      - MIN_PAYOUT=1.0
      - BLOCK_REFRESH_INTERVAL=1000
      - WALLET_ADDRESS=Z3222ywic7fGUZHv9EfFwEKf1VJRrEqPbLrHgRiBb43LWaS1Cz2gVwgdF2kvUPsGb9jSvUUf31oNCSZgNEtUiGDT4sBLtXmGzc
    ports:
      - "3333:3333"  # Stratum port
      - "8117:8080"  # Web stats
    volumes:
      - ./logs:/logs
      - zion-pool-data:/data
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "3333"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 45s
    restart: unless-stopped
    networks:
      - zion-net
    depends_on:
      rpc-shim:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # WALLET SERVICE - Pro pool payouts
  wallet-service:
    image: zion:bootstrap-fixed
    container_name: zion-wallet-bootstrap
    command: >
      zion_walletd
      --daemon-address=seed1
      --daemon-port=18081
      --bind-address=0.0.0.0
      --bind-port=8070
      --container-file=/data/pool-wallet.wallet
      --container-password=$${WALLET_PASSWORD:-ZionBootstrap2025TempDev}
      --generate-container
      --log-level=2
    environment:
      - WALLET_PASSWORD=${WALLET_PASSWORD:-ZionBootstrap2025TempDev}
    ports:
      - "8070:8070"
    volumes:
      - zion-wallet-data:/data
      - ./config:/config:ro
      - ./logs:/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8070/json_rpc", "-d", '{"jsonrpc":"2.0","id":1,"method":"getaddresses","params":{}}', "-H", "Content-Type: application/json"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - zion-net
    depends_on:
      seed1:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

volumes:
  zion-seed1-data:
    name: zion-seed1-bootstrap-data
  zion-seed2-data:
    name: zion-seed2-bootstrap-data
  zion-pool-data:
    name: zion-pool-bootstrap-data
  zion-wallet-data:
    name: zion-wallet-bootstrap-data

networks:
  zion-net:
    name: zion-bootstrap-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16